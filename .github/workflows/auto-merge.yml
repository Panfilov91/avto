name: Auto-merge PRs

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'auto-merge') || contains(github.event.pull_request.title, '[auto-merge]')
    steps:
      - name: Check PR status
        id: check-status
        run: |
          echo "Checking if all PR checks have passed..."
          echo "PR: ${{ github.event.pull_request.number }}"
          echo "Title: ${{ github.event.pull_request.title }}"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Wait for status checks
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo, number } = context.issue;
            
            // Wait for status checks to complete
            await github.rest.checks.listForRef({
              owner,
              repo,
              ref: context.payload.pull_request.head.sha,
            });
            
            console.log('âœ“ Status checks verified');

      - name: Merge PR
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo, number } = context.issue;
            
            try {
              const result = await github.rest.pulls.merge({
                owner,
                repo,
                pull_number: number,
                merge_method: 'squash',
              });
              console.log(`âœ“ PR #${number} successfully merged`);
              console.log('Merge details:', result.data);
            } catch (error) {
              console.error(`Error merging PR #${number}:`, error.message);
              throw error;
            }

      - name: Delete branch
        uses: actions/github-script@v7
        if: success()
        with:
          script: |
            const { owner, repo } = context.repo;
            const branchName = context.payload.pull_request.head.ref;
            
            try {
              await github.rest.git.deleteRef({
                owner,
                repo,
                ref: `heads/${branchName}`,
              });
              console.log(`âœ“ Branch '${branchName}' deleted after merge`);
            } catch (error) {
              console.warn(`Could not delete branch '${branchName}': ${error.message}`);
            }

      - name: Comment on merged PR
        uses: actions/github-script@v7
        if: success()
        with:
          script: |
            const { owner, repo, number } = context.issue;
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: number,
              body: 'âœ… Auto-merged successfully! ðŸš€\n\nThis PR was automatically merged and the branch has been deleted.',
            });
